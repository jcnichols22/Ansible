---
# Step 1: Bootstrap users and SSH keys everywhere
- name: Ensure users and SSH keys exist (all hosts, root only, before facts)
  hosts: all
  vars:
    ansible_user: root
  become: true
  gather_facts: true
  # users variable now loaded automatically from group_vars/all.yml
  roles:
    - role: base

# Step 2: Media Servers (Ubuntu/Debian only)
- name: Onboarding for Media Servers
  hosts: media_servers
  become: true

  pre_tasks:
    - name: Update and upgrade apt packages
      ansible.builtin.apt:
        update_cache: yes
        upgrade: dist
        autoremove: yes
        autoclean: yes
      tags: apt

    - name: Ensure snapd is installed
      ansible.builtin.apt:
        name: snapd
        state: present
      tags: snap

    - name: Check if snap command is available
      ansible.builtin.stat:
        path: /usr/bin/snap
      register: snap_stat

  tasks:
    - name: Upgrade all snap packages
      ansible.builtin.command: snap refresh
      when: snap_stat.stat.exists
      tags: snap

  roles:
    - dotfiles
    - media_server

# Step 3: Workstations (Ubuntu/Debian only)
- name: Onboarding for Workstations
  hosts: workstations
  become: true

  pre_tasks:
    - name: Update and upgrade apt packages (Debian/Ubuntu)
      ansible.builtin.apt:
        update_cache: yes
        upgrade: dist
        autoremove: yes
        autoclean: yes
      tags: apt
      when: ansible_os_family == "Debian"

    - name: Ensure snapd is installed (Debian/Ubuntu)
      ansible.builtin.apt:
        name: snapd
        state: present
      tags: snap
      when: ansible_os_family == "Debian"
    - name: Check if snap command is available
      ansible.builtin.stat:
        path: /usr/bin/snap
      register: snap_stat

  tasks:
    - name: Upgrade all snap packages
      ansible.builtin.command: snap refresh
      when: snap_stat.stat.exists
      tags: snap

  roles:
    - dotfiles
    - workstations

# Step 4: All Other Hosts (Ubuntu/Debian only)
- name: Onboarding for All Other Hosts
  hosts: all:!media_servers:!workstations
  become: true

  pre_tasks:
    - name: Update and upgrade apt packages
      ansible.builtin.apt:
        update_cache: yes
        upgrade: dist
        autoremove: yes
        autoclean: yes
      tags: apt

    - name: Ensure snapd is installed
      ansible.builtin.apt:
        name: snapd
        state: present
      tags: snap

    - name: Check if snap command is available
      ansible.builtin.stat:
        path: /usr/bin/snap
      register: snap_stat

  tasks:
    - name: Upgrade all snap packages
      ansible.builtin.command: snap refresh
      when: snap_stat.stat.exists
      tags: snap

  roles:
    - dotfiles
