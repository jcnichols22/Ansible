---
# Setup Syncthing sync for media servers with backup configuration
# This playbook configures media servers to sync with each other and receive backups

- name: Setup Syncthing for media servers
  hosts: media_server
  become: true
  gather_facts: true

  vars:
    syncthing_user: "josh"

    # Media server specific devices
    syncthing_devices:
      - name: "MainMediaServer"
        id: "REPLACE-WITH-MEDIA-SERVER-DEVICE-ID"
        addresses: "tcp://192.168.0.102:22000"
      - name: "BackupServer"
        id: "REPLACE-WITH-BACKUP-SERVER-DEVICE-ID"
        addresses: "dynamic"

    # Media folders to sync
    syncthing_folders:
      - id: "media-config"
        label: "Media Server Configs"
        path: "/home/{{ syncthing_user }}/docker-configs"
        devices:
          - "MainMediaServer"
          - "BackupServer"
        type: "sendreceive"
        rescan_interval: 7200

      - id: "media-backups"
        label: "Media Backups"
        path: "/mnt/backups"
        devices:
          - "BackupServer"
        type: "sendonly" # Only send, don't receive
        rescan_interval: 86400 # Daily

    # Allow remote GUI access for management
    syncthing_gui_address: "0.0.0.0:8384"
    syncthing_gui_user: "admin"
    syncthing_gui_password: "CHANGE-THIS-PASSWORD" # Use ansible-vault for production

    # Enable firewall rules
    syncthing_firewall_enabled: true

  roles:
    - syncthing

  post_tasks:
    - name: Display media server sync info
      ansible.builtin.debug:
        msg: |
          Syncthing configured on {{ ansible_hostname }}
          Web GUI: http://{{ ansible_default_ipv4.address }}:8384
          Username: {{ syncthing_gui_user }}
          Folders syncing: {{ syncthing_folders | length }}
      tags: syncthing
