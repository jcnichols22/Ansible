---
- name: Ensure required packages are installed
  apt:
    name: "{{ required_packages }}"
    state: present
  become: true

- name: Ensure users exist and have SSH keys
  user:
    name: "{{ item.name }}"
    state: present
    shell: /bin/bash
  loop: "{{ users }}"
  become: true

- name: Set up authorized_keys for each user
  authorized_key:
    user: "{{ item.name }}"
    key: "{{ item.ssh_key }}"
    state: present
  loop: "{{ users }}"
  become: true

- name: Clone dotfiles repo for each user
  git:
    repo: "{{ dotfiles_repo }}"
    dest: "/home/{{ item.name }}/dotfiles"
    version: HEAD
    update: yes
    force: yes
  become: true
  become_user: "{{ item.name }}"
  loop: "{{ users }}"

- name: Copy .bash_aliases from repo to user's home
  copy:
    src: "/home/{{ item.name }}/dotfiles/.bash_aliases"
    dest: "/home/{{ item.name }}/.bash_aliases"
    owner: "{{ item.name }}"
    group: "{{ item.name }}"
    mode: '0644'
    remote_src: yes
  become: true
  loop: "{{ users }}"
