---
# Syncthing installation and configuration tasks

# --- Installation (Debian/Ubuntu) ---

- name: Add Syncthing GPG key (Debian/Ubuntu)
  ansible.builtin.get_url:
    url: https://syncthing.net/release-key.gpg
    dest: /usr/share/keyrings/syncthing-archive-keyring.gpg
    mode: "0644"
  when:
    - ansible_distribution in ["Debian", "Ubuntu"]
    - syncthing_install_method == "official"
  become: true
  tags: syncthing

- name: Add Syncthing repository (Debian/Ubuntu)
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/syncthing-archive-keyring.gpg] https://apt.syncthing.net/ syncthing stable"
    state: present
    filename: syncthing
  when:
    - ansible_distribution in ["Debian", "Ubuntu"]
    - syncthing_install_method == "official"
  become: true
  tags: syncthing

- name: Create Syncthing apt sources file manually (Debian/Ubuntu)
  ansible.builtin.copy:
    content: "deb [signed-by=/usr/share/keyrings/syncthing-archive-keyring.gpg] https://apt.syncthing.net/ syncthing stable"
    dest: /etc/apt/sources.list.d/syncthing.list
    mode: "0644"
  when:
    - ansible_distribution in ["Debian", "Ubuntu"]
    - syncthing_install_method == "official"
  become: true
  tags: syncthing

- name: Update apt cache (Debian/Ubuntu)
  ansible.builtin.apt:
    update_cache: true
  when: ansible_distribution in ["Debian", "Ubuntu"]
  become: true
  tags: syncthing

- name: Install Syncthing packages (Debian/Ubuntu)
  ansible.builtin.apt:
    name: "{{ syncthing_packages_debian }}"
    state: present
  when: ansible_distribution in ["Debian", "Ubuntu"]
  become: true
  tags: syncthing

# --- Installation (Arch) ---

- name: Install Syncthing packages (Arch)
  community.general.pacman:
    name: "{{ syncthing_packages_arch }}"
    state: present
  when: ansible_os_family == "Archlinux"
  become: true
  tags: syncthing

# --- User Configuration ---

- name: Ensure syncthing user exists
  ansible.builtin.user:
    name: "{{ syncthing_user }}"
    shell: /bin/bash
    create_home: true
  become: true
  tags: syncthing

- name: Ensure syncthing data directory exists
  ansible.builtin.file:
    path: "{{ syncthing_data_dir }}"
    state: directory
    owner: "{{ syncthing_user }}"
    group: "{{ syncthing_user }}"
    mode: "0755"
  become: true
  tags: syncthing

- name: Ensure syncthing dotfiles directory exists
  ansible.builtin.file:
    path: "{{ syncthing_dotfiles_dir }}"
    state: directory
    owner: "{{ syncthing_user }}"
    group: "{{ syncthing_user }}"
    mode: "0755"
  become: true
  when: syncthing_dotfiles_dir is defined
  tags: syncthing

- name: Ensure syncthing config directory exists
  ansible.builtin.file:
    path: "{{ syncthing_config_dir }}"
    state: directory
    owner: "{{ syncthing_user }}"
    group: "{{ syncthing_user }}"
    mode: "0755"
  become: true
  tags: syncthing

# --- Service Setup ---

- name: Deploy Syncthing system service unit
  ansible.builtin.template:
    src: syncthing-user.service.j2
    dest: "/etc/systemd/system/syncthing-{{ syncthing_user }}.service"
    mode: "0644"
  become: true
  when:
    - ansible_service_mgr == "systemd"
    - syncthing_service_type == "system"
  notify: restart syncthing
  tags: syncthing

- name: Enable and start Syncthing system service
  ansible.builtin.systemd:
    name: "syncthing-{{ syncthing_user }}"
    enabled: "{{ syncthing_service_enabled }}"
    state: "{{ syncthing_service_state }}"
    daemon_reload: true
    scope: system
  become: true
  when:
    - ansible_service_mgr == "systemd"
    - syncthing_service_type == "system"
  tags: syncthing

- name: Enable and start Syncthing user service
  ansible.builtin.systemd:
    name: "syncthing@{{ syncthing_user }}"
    enabled: "{{ syncthing_service_enabled }}"
    state: "{{ syncthing_service_state }}"
    scope: system
  become: true
  when:
    - ansible_service_mgr == "systemd"
    - syncthing_service_type == "user"
  tags: syncthing

- name: Wait for Syncthing to create initial config
  ansible.builtin.wait_for:
    path: "{{ syncthing_config_dir }}/config.xml"
    timeout: 30
  tags: syncthing

- name: Stop Syncthing service for initial configuration
  ansible.builtin.systemd:
    name: "syncthing-{{ syncthing_user if syncthing_service_type == 'system' else '@' + syncthing_user }}"
    state: stopped
    scope: system
  become: true
  when: ansible_service_mgr == "systemd"
  tags: syncthing

# --- Configuration ---

- name: Read current Syncthing config
  ansible.builtin.slurp:
    src: "{{ syncthing_config_dir }}/config.xml"
  register: syncthing_config_content
  tags: syncthing

- name: Parse existing device ID
  ansible.builtin.set_fact:
    syncthing_device_id: "{{ syncthing_config_content['content'] | b64decode | regex_search('<device id=\"([^\"]+)\"', '\\1') | first }}"
  tags: syncthing

- name: Display device ID for reference
  ansible.builtin.debug:
    msg: "Syncthing Device ID for {{ ansible_hostname }}: {{ syncthing_device_id }}"
  tags: syncthing

- name: Template Syncthing configuration
  ansible.builtin.template:
    src: config.xml.j2
    dest: "{{ syncthing_config_dir }}/config.xml"
    owner: "{{ syncthing_user }}"
    group: "{{ syncthing_user }}"
    mode: "0600"
    backup: true
  become: true
  notify: restart syncthing
  tags: syncthing

# --- Folder Creation ---

- name: Create Syncthing sync folders
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ syncthing_user }}"
    group: "{{ syncthing_user }}"
    mode: "0755"
  loop: "{{ syncthing_folders }}"
  when: syncthing_folders | length > 0
  become: true
  tags: syncthing

- name: Create .stignore files for folders with ignore patterns
  ansible.builtin.copy:
    content: |
      # Syncthing ignore patterns
      {% for pattern in item.ignore_patterns | default([]) %}
      {{ pattern }}
      {% endfor %}
    dest: "{{ item.path }}/.stignore"
    owner: "{{ syncthing_user }}"
    group: "{{ syncthing_user }}"
    mode: "0644"
  loop: "{{ syncthing_folders }}"
  when:
    - syncthing_folders | length > 0
    - item.ignore_patterns is defined
    - item.ignore_patterns | length > 0
  become: true
  tags: syncthing

# --- Start Service ---

- name: Start Syncthing service after configuration
  ansible.builtin.systemd:
    name: "syncthing-{{ syncthing_user if syncthing_service_type == 'system' else '@' + syncthing_user }}"
    state: started
    scope: system
  become: true
  when: ansible_service_mgr == "systemd"
  tags: syncthing

# --- Firewall (optional) ---

- name: Allow Syncthing ports through UFW (if UFW is active)
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop:
    - "22000" # TCP sync port
    - "8384" # GUI port (if accessible remotely)
  when:
    - ansible_distribution in ["Debian", "Ubuntu"]
    - syncthing_firewall_enabled | default(false)
  become: true
  ignore_errors: true
  tags: syncthing

- name: Allow Syncthing UDP discovery port through UFW
  community.general.ufw:
    rule: allow
    port: "21027"
    proto: udp
  when:
    - ansible_distribution in ["Debian", "Ubuntu"]
    - syncthing_firewall_enabled | default(false)
  become: true
  ignore_errors: true
  tags: syncthing
